<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quote Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 40px;
    }
    h2 {
      margin-bottom: 20px;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 1em;
    }
    .stage-chain {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 10px 0;
      padding: 10px;
    }
    .stage {
      flex: 1;
      text-align: center;
      padding: 10px;
      border-radius: 6px;
      margin: 0 5px;
      background-color: #d3d3d3;
      color: #333;
      font-weight: bold;
      position: relative;
    }
    .stage:before {
      content: "";
      position: absolute;
      top: 50%;
      left: -5px;
      width: 10px;
      height: 10px;
      background: #333;
      border-radius: 50%;
      transform: translateY(-50%);
    }
    .stage:first-child:before { display: none; }

    .active { background-color: #28a745; color: white; }
    .complete { background-color: #007bff; color: white; }
    .future { background-color: #d3d3d3; color: #555; }

    #login-section, #dashboard-section {
      max-width: 700px;
      margin: auto;
    }

    .btn-row {
      margin: 20px 0;
    }

    .btn-row button {
      margin-right: 10px;
    }

    .rfp-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .time-remaining {
      font-size: 0.95em;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div id="login-section">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email" /><br>
    <input type="password" id="password" placeholder="Password" /><br>
    <button id="login-button">Login</button>
    <p id="login-error" style="color:red;"></p>
  </div>

  <div id="dashboard-section" style="display:none;">
    <h2 id="welcome-msg"></h2>
    <div class="btn-row">
      <button id="submit-button">Submit New RFP</button>
      <button id="refresh-button">Refresh Tracker</button>
      <button id="logout-button">Logout</button>
    </div>
    <div id="tracker-container"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    const STAGES = ["Census Received", "Processing", "Engaging Carriers", "Preparing Quote", "Quote Returned"];
    let lastSeenStages = {};

    async function verifyBroker() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      const res = await fetch(`/api/verify-broker?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
      const data = await res.json();

      if (res.ok) {
        sessionStorage.setItem("brokerName", data.brokerName);
        sessionStorage.setItem("brokerEmail", email);
        sessionStorage.setItem("brokerPassword", password);
        loadDashboard();
      } else {
        document.getElementById("login-error").textContent = "Invalid email or password.";
      }
    }

    function loadDashboard() {
      const name = sessionStorage.getItem("brokerName");
      const email = sessionStorage.getItem("brokerEmail");

      if (!name || !email) return;

      document.getElementById("login-section").style.display = "none";
      document.getElementById("dashboard-section").style.display = "block";
      document.getElementById("welcome-msg").textContent = `Welcome, ${name}`;

      fetch(`/api/projects?broker=${encodeURIComponent(name)}`)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("tracker-container");
          container.innerHTML = "";
          if (!data.length) {
            container.innerHTML = "<p>No RFPs found.</p>";
            return;
          }

          data.forEach(rfp => {
            const currentStage = rfp.stage;
            const stageIndex = STAGES.indexOf(currentStage);
            const stageKey = rfp.projectName;
            const prevStage = lastSeenStages[stageKey];
            lastSeenStages[stageKey] = currentStage;

            if (currentStage === "Quote Returned" && prevStage !== "Quote Returned") {
              confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
            }

            const card = document.createElement("div");
            card.className = "rfp-card";
            card.innerHTML = `<h3>${rfp.projectName}</h3>`;

            const chain = document.createElement("div");
            chain.className = "stage-chain";

            STAGES.forEach((stage, i) => {
              const el = document.createElement("div");
              el.classList.add("stage");

              if (i < stageIndex) el.classList.add("complete");
              else if (i === stageIndex) el.classList.add("active");
              else el.classList.add("future");

              el.textContent = stage;
              chain.appendChild(el);
            });

            const hours = parseInt((parseFloat(rfp.timeRemaining) || 0) * 24);
            const timeText = isNaN(hours) ? "N/A" : `${hours} hour${hours !== 1 ? 's' : ''}`;

            const timeInfo = document.createElement("div");
            timeInfo.className = "time-remaining";
            timeInfo.textContent = `Time Remaining: ${timeText}`;

            card.appendChild(chain);
            card.appendChild(timeInfo);
            container.appendChild(card);
          });
        });
    }

    function openRfpForm() {
      const name = sessionStorage.getItem("brokerName");
      const email = sessionStorage.getItem("brokerEmail");
      const password = sessionStorage.getItem("brokerPassword");
      const url = `https://airtable.com/appTl5b0TOB6Sh8N5/pagd8oOz2RO9zbYGb/form?prefill_Username=${encodeURIComponent(name)}&prefill_Email=${encodeURIComponent(email)}&prefill_Password=${encodeURIComponent(password)}`;
      window.open(url, "_blank");
    }

    function logout() {
      sessionStorage.clear();
      location.reload();
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("login-button").addEventListener("click", verifyBroker);
      document.getElementById("submit-button").addEventListener("click", openRfpForm);
      document.getElementById("refresh-button").addEventListener("click", loadDashboard);
      document.getElementById("logout-button").addEventListener("click", logout);

      if (sessionStorage.getItem("brokerName")) {
        loadDashboard();
      }
    });
  </script>
</body>
</html>
